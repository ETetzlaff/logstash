#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

indent() {
  sed -u 's/^/       /'
}

INIT_SCRIPT="$BUILD_DIR/.profile.d/logstash.sh"

echo "-----> Found a Logstash file"
if [ ! -s $1/Logstash ]; then
  echo "Logstash was empty"
  exit 1
else
  echo "Logstash is not empty, here are the contents" | indent
  cat $1/Logstash
fi | indent

# TODO: Need to detect if version is specified in Logstash and modify DOWNLOAD_URL accordingly
DOWNLOAD_URL="https://download.elastic.co/logstash/logstash/logstash-5.4.0.tar.gz"

echo "-----> Installing Logstash..."

mkdir $CACHE_DIR
echo "downloading $DOWNLOAD_URL" | indent
curl -sLO $DOWNLOAD_URL

mv logstash-5.4.0.tar.gz $CACHE_DIR

tar -xzvf $CACHE_DIR/logstash-5.4.0.tar.gz $BUILD_DIR
LOGSTASH_DIR=$BUILD_DIR/logstash-5.4.0

echo "Exporting PATH" | indent
echo 'export PATH="$PATH:'${LOGSTASH_DIR##*/}'/bin"' > $INIT_SCRIPT
